<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.94.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Authorizing Only Your Team With Ansible&nbsp;&ndash;&nbsp;Today I Learned</title><link rel=stylesheet href=/today-i-learned/css/core.min.1f33ddd26b7552f4b05d1d3549be1d243861a78395c5e5e2c603e7170168406fc4a520256687dc5c440ee13cb7050bde.css integrity=sha384-HzPd0mt1UvSwXR01Sb4dJDhhp4OVxeXixgPnFwFoQG/EpSAlZofcXEQO4Ty3BQve><meta name=twitter:card content="summary"><meta name=twitter:title content="Authorizing Only Your Team With Ansible"><base href=https://reitzig.github.io/today-i-learned/><link rel=icon href="data:;base64,="><meta name=author content="Raphael Reitzig"><meta name=description content="
Authorizing SSH keys with Ansible is made easy by the authorized_key module.
Or is it?
"><meta name=keywords content="Tool,Ansible,DevOps"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/today-i-learned/><span class="site name">Today I Learned</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/today-i-learned/tags/>Tags</a><a class="nav item" href=impressum>About</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Authorizing Only Your Team With Ansible</h1><p class="article date">2020-05-14</p><p class="article github_edit"><a rel=nofollow href=https://github.com/reitzig/today-i-learned/edit/master/content/posts/2020-05-14-manage-authorized-ssh-keys-with-ansible.adoc></a></p></section><article class="article markdown-body"><div class=paragraph><p>Authorizing SSH keys with Ansible is made easy by the <code>authorized_key</code> module.
Or is it?</p></div><div class=paragraph><p>In the most simple case, we just want to authorize a single key, say the one of the current user:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>- name: Authorize me
  authorized_key:
    user: &#34;john_doe&#34;
    key: &#34;{{ lookup(&#39;file&#39;, lookup(&#39;env&#39;,&#39;HOME&#39;) + &#39;/.ssh/id_rsa.pub&#39;) }}&#34;
    state: present</code></pre></div></div><div class=paragraph><p>Now, in our project we wanted to authorize multiple team members for a shared account,
potentially with differences between hosts.
So we put public keys in the playbook repository and did something like this:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>- name: Authorize team
  authorized_key:
    user: &#34;team_doe&#34;
    key: &#34;{{ lookup(&#39;file&#39;, item) }}&#34;
    state: present
  with_fileglob:
    - &#34;config/{{ inventory_dir | basename }}/ssh_keys/*.pub&#34;</code></pre></div></div><div class=paragraph><p>This is nice, but has a fatal flaw:
We do not de-authorize keys when we remove them from the playbook!
In case of a single key, we would solve this by adding <code>exclusive: true</code> but, alas,
this is
<a href=https://docs.ansible.com/ansible/2.9/modules/authorized_key_module.html#parameter-exclusive>not possible here</a>:</p></div><div class=quoteblock><blockquote>This option is not loop aware, so if you use <code>with_</code>, it will be exclusive per iteration of the loop.
If you want multiple keys in the file you need to pass them all to key in a single batch as mentioned above.</blockquote></div><div class=paragraph><p>Therefore, we have to concatenate the key files.
We could do this up-front and have only a single file with all keys in the playbook,
but we prefer one file per key for transparency and maintainability reasons.
Lucky for us, there we can also
<a href=https://stackoverflow.com/a/41843308/539599>assemble a multi-line string inline</a>:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>- name: Authorize team
  authorized_key:
    user: &#34;team_doe&#34;
    key: |
      {% for filename in lookup(&#39;fileglob&#39;, &#39;config/{{ inventory_dir | basename }}/ssh_keys/*.pub&#39;, wantlist=true) -%}
      {{ lookup(&#39;file&#39;, filename) }}

      {% endfor %}
    state: present
    exclusive: true</code></pre></div></div><div class=paragraph><p>Note the extra empty line in the <code>for</code>-loop which translates into a line-break in the resulting string.</p></div><div class="admonitionblock caution"><table><tbody><tr><td class=icon><img src=assets/icons/caution.svg alt=Caution></td><td class=content>The output of <code>ansible-playbook</code> does not seem to indicate that it removed any keys from the server.
You may want to check separately that the desired effect was achieved.</td></tr></tbody></table></div></article><section class="article labels"><a class=tag href=/today-i-learned/tags/tool/>Tool</a><a class=tag href=/today-i-learned/tags/ansible/>Ansible</a><a class=tag href=/today-i-learned/tags/devops/>DevOps</a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/today-i-learned/posts/2020-05-20-kotlin-native-in-ubi/><span class="iconfont icon-article"></span>Kotlin Native in UBI</a></p><p><a class=link href=/today-i-learned/posts/2020-05-04-argument-types-with-click/><span class="iconfont icon-article"></span>Documenting Argument Types With Click</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>Â© 2020 &ndash; 2022 Raphael Reitzig<br>This work is licensed under a
<a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License
</a>.<br><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=border-width:0 src=cc-by-80x15.png></a></p><p class=powerby><span>Powered&nbsp;by&nbsp;</span><a href=https://gohugo.io target=_blank>Hugo</a><span>&nbsp;&&nbsp;</span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section><script src=/today-i-learned/js/hljs.min.011f34967852b995d9282c924274532b818970a2a6bfee2ae10e44fbf0ba6c0023b0269f3498a7430c72f9362e267b90.js integrity=sha384-AR80lnhSuZXZKCySQnRTK4GJcKKmv+4q4Q5E+/C6bAAjsCafNJinQwxy+TYuJnuQ></script><script>hljs.initHighlightingOnLoad()</script></body></html>