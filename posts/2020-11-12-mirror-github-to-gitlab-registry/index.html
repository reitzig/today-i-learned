<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Private GitLab mirror of a public GitHub repository&nbsp;&ndash;&nbsp;Today I Learned</title><link rel=stylesheet href=/today-i-learned/css/core.min.79f78e88c205b020a3463276d6dcabf3e77e390411d3688f16417d133f3dbfa7ba2287299fb4599a230560901d298067.css integrity=sha384-efeOiMIFsCCjRjJ21tyr8+d+OQQR02iPFkF9Ez89v6e6Iocpn7RZmiMFYJAdKYBn><meta name=twitter:card content="summary"><meta name=twitter:title content="Private GitLab mirror of a public GitHub repository"><base href=https://reitzig.github.io/today-i-learned/><link rel=icon href="data:;base64,="><meta name=author content="Raphael Reitzig"><meta name=description content="
Have you ever needed a &#34;manual&#34; mirror of a repository on GitLab?
"><meta name=keywords content="GitLab,Tool"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/today-i-learned/><span class="site name">Today I Learned</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/today-i-learned/tags/>Tags</a><a class="nav item" href=impressum>About</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Private GitLab mirror of a public GitHub repository</h1><p class="article date">2020-11-12</p><p class="article github_edit"><a rel=nofollow href=https://github.com/reitzig/today-i-learned/edit/master/content/posts/2020-11-12-mirror-github-to-gitlab-registry.adoc></a></p><p class="article tweet_link"><a href=https://twitter.com/OmegaPolice/status/1326921829294989312><span class="iconfont icon-twitter"></span></a></p></section><article class="article markdown-body"><div class=paragraph><p>Have you ever needed a "manual" mirror of a repository on GitLab?</p></div><div class=paragraph><p>In our case,
we want to use a library as Maven dependency.
While it is published under an OSS license on GitHub,
there is no Maven deployment (yet) — we need to deploy it for ourselves.
The basic idea is to</p></div><div class=ulist><ul><li><p>pull the upstream <code>master</code> every night,</p></li><li><p>rebase our changes (if any) on top, and</p></li><li><p>push the result to our repository;</p></li><li><p>on every push, build and deploy the library.</p></li></ul></div><div class=paragraph><p>The last part depends on your actual goal and is interchangeable;
the tricky bit is mirroring the repository.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><img src=assets/icons/note.svg alt=Note></td><td class=content>GitLab <em>does</em> have
<a href=https://docs.gitlab.com/ee/user/project/repository/repository_mirroring.html#pulling-from-a-remote-repository>pull-mirroring built in</a> — if you pay for it.
I don't know how well that covers making <em>changes</em> to that fork, though.</td></tr></tbody></table></div><div class=paragraph><p>Here is what you do.</p></div><div class=sect1><h2 id=_gitlab>GitLab</h2><div class=sectionbody><div class=paragraph><p>Perform these steps in the web UI of GitLab.
I'm sure they can be automated using the API,
but even I couldn't be bothered to script such a rare occurrence.</p></div><div class="olist arabic"><ol class=arabic><li><p>Create a new project.</p></li><li><p>Unprotect <code>master</code>.</p></li><li><p>Add a deploy key with write access to the repository.</p></li><li><p>Create two pipeline variables:</p><div class=dlist><dl><dt class=hdlist1><code>SSH_PRIVATE_KEY</code></dt><dd><p>Paste the private key you just created here.</p></dd><dt class=hdlist1><code>SSH_KNOWN_HOSTS</code></dt><dd><p>Paste the SSH server key fingerprints of your GitLab instance.</p></dd></dl></div></li><li><p>Create a pipeline schedule on <code>master</code>.</p></li></ol></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><img src=assets/icons/note.svg alt=Note></td><td class=content>Why the SSH key, you might ask?
While the documentation seems to suggest that accessing the current repository should be possible with a project access token,
it <a href=https://stackoverflow.com/q/63924723/539599>doesn't seem to be</a>.
Hence, this <a href=https://docs.gitlab.com/ee/ci/ssh_keys/>workaround</a>.</td></tr></tbody></table></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><img src=assets/icons/warning.svg alt=Warning></td><td class=content>You'll note that this gives the GitLab CI pipeline the power to do pretty much anything on that repository.
Given that this is only a mirror, I consider the potential risks negligible.</td></tr></tbody></table></div></div></div><div class=sect1><h2 id=_local>Local</h2><div class=sectionbody><div class=paragraph><p>Grab yourself a shell!</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>git clone git@my-gitlab:my-team/that-library.git
git remote add upstream &#34;https://github.com/that-team/that-library.git&#34;
git pull upstream master --rebase</code></pre></div></div><div class=paragraph><p>Add the GitLab pipeline:</p></div><div class=listingblock><div class=title>.gitlab-ci.yml</div><div class=content><pre class=highlight><code class=language-yaml data-lang=yaml>stages:
  - Pull Upstream
  - Publish Maven Artifacts

pull_upstream:
  stage: Pull Upstream
  only:
    - schedules
  before_script:
    - apt-get update -qq &amp;&amp; apt-get install -y -qq git openssh-client
    - eval $(ssh-agent -s)
    - echo &#34;${SSH_PRIVATE_KEY}&#34; | tr -d &#39;\r&#39; | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo &#34;${SSH_KNOWN_HOSTS}&#34; &gt;&gt; ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - git config --global user.name &#34;${GITLAB_USER_NAME}&#34;
    - git config --global user.email &#34;${GITLAB_USER_EMAIL}&#34;
  script:
    - git checkout master
    - git pull &#34;https://github.com/that-team/that-library.git&#34; master --rebase
    - git push -f &#34;git@my-gitlab:my-team/that-library.git&#34; master

publish:
  stage: Publish Maven Artifacts
  only:
    - master
  except:
    - schedules
  image: maven:3.6.3-jdk-11
  cache:
    paths:
      - .m2/repository
  variables:
    MAVEN_CLI_OPTS: &#34;--batch-mode --settings settings_ci.xml&#34;
    MAVEN_OPTS: &#34;-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository&#34;
  script:
    - mvn ${MAVEN_CLI_OPTS} deploy</code></pre></div></div><div class=paragraph><p>The <code>publish</code> stage depends on what you want to do, of course.
In our case, we needed to change the Maven configuration as well;
that part is <a href=https://docs.gitlab.com/ee/user/packages/maven_repository/>well documented</a>.</p></div><div class=paragraph><p>Finally, a plain</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>git commit --all -m &#34;OVERRIDE: CI/CD for the fork&#34;
git push origin master</code></pre></div></div><div class=paragraph><p>seals the deal and runs the first deployment.
The setup keeps deploying new versions of the library as they appear,
unless the nightly rebase fails;
in that case we have to resolve the conflicts locally.</p></div></div></div></article><section class="article labels"><a class=tag href=/today-i-learned/tags/gitlab/>GitLab</a><a class=tag href=/today-i-learned/tags/tool/>Tool</a></section><section class="article tweet">Comment & Share on 
    <a href=https://twitter.com/OmegaPolice/status/1326921829294989312>Twitter&nbsp;<span class="iconfont icon-twitter"></span></a></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/today-i-learned/posts/2021-03-26-project-specific-shell-config/><span class="iconfont icon-article"></span>Project-Specific Shell Configuration</a></p><p><a class=link href=/today-i-learned/posts/2020-10-14-postpone-discussions-gitlab/><span class="iconfont icon-article"></span>Postpone Discussions in GitLab</a></p></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2020 &ndash; 2021 Raphael Reitzig<br>This work is licensed under a
<a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License
</a>.<br><a rel=license href=http://creativecommons.org/licenses/by/4.0/><img alt="Creative Commons License" style=border-width:0 src=cc-by-80x15.png></a></p><p class=powerby><span>Powered&nbsp;by&nbsp;</span><a href=https://gohugo.io target=_blank>Hugo</a><span>&nbsp;&&nbsp;</span><a href=https://themes.gohugo.io/hugo-notepadium/ target=_blank>Notepadium</a></p></div></section><script src=/today-i-learned/js/hljs.min.72e76ccf211868d08e31d7ca45c02501991bd760f28809c52045fa79fb7b7428664bb54ae875b46031ebc760c77b9562.js integrity=sha384-cudszyEYaNCOMdfKRcAlAZkb12DyiAnFIEX6eft7dChmS7VK6HW0YDHrx2DHe5Vi></script><script>hljs.initHighlightingOnLoad()</script></body></html>